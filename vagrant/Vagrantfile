Vagrant.configure("2") do |config|
  # Use the Ubuntu 18.04 box
  config.vm.box = "ubuntu/jammy64"
  #config.vm.disk :disk, size: "100GB", primary: true
  config.disksize.size = '40GB'
  
  if Vagrant.has_plugin?("vagrant-vbguest")
    config.vbguest.auto_update = false
    config.vbguest.no_install = true
    # Optional: suppress prompts
    config.vbguest.no_remote = true
  end
  
  # Disable the default /vagrant synced folder
  config.vm.synced_folder ".", "/vagrant", disabled: true
  
  # Auto-detect parent folder of this Vagrantfile
  parent_folder = File.expand_path("..", __dir__)
  # Use the parent folder's name as the mount point
  mount_point = "/home/vagrant/" + File.basename(parent_folder)

  simva_vm_memory = ENV['VBOX_MEMORY'] || 8192
  simva_vm_cpu = ENV['VBOX_CPU'] || 8

  #Example: share current folder with the VM using SMB
  config.vm.synced_folder parent_folder, mount_point,
        type: "virtualbox",        # VirtualBox shared folder
        owner: "vagrant",          # Optional: set guest owner
        group: "vagrant",          # Optional: set guest group
        mount_options: ["dmode=775","fmode=775"]  # Optional: permissions

  # Set the VM name in Hyper-V Manager
  config.vm.provider "virtualbox" do |vb|
    vb.name = "SIMVA-INFRA-VAGRANT"
    vb.cpus = simva_vm_cpu
    vb.memory = simva_vm_memory

    vb.customize ["modifyvm",:id,"--nic2","hostonly"]
    vb.customize ["modifyvm",:id,"--cableconnected2","on"] 
  end

  config.vm.boot_timeout = 500

  simva_vm_ip = ENV['VBOX_EXTERNAL_IP'] || "172.30.0.1"

  host_gitconfig = File.expand_path("~/.gitconfig")
  config.vm.provision "file", source: host_gitconfig, destination: "/home/vagrant/.gitconfig.host"
  fix_network_error = ENV['FIX_NETWORK_ERROR'] || "false"

  config.vm.provision "shell", run: "always", inline: <<-SHELL
    if [ "#{fix_network_error}" == "true" ]; then
      # FIX NETWORK Errors
      sudo systemctl stop systemd-resolved
      sudo systemctl disable systemd-resolved
      if [ -f "/etc/resolv.conf.backup" ]; then
        echo "/etc/resolv.conf.backup already exists, skipping backup."
      else
        echo "Backing up /etc/resolv.conf to /etc/resolv.conf.backup"
        cp /etc/resolv.conf /etc/resolv.conf.backup || true
        sudo rm -f /etc/resolv.conf
        echo -e "nameserver 8.8.8.8\nnameserver 1.1.1.1\nnameserver 9.9.9.9" | sudo tee /etc/resolv.conf
        sudo chattr +i /etc/resolv.conf
      fi
      sudo systemctl restart systemd-networkd
    fi
  SHELL
  
  # Provision VM automatically with a shell script
  config.vm.provision "shell", run: "always" do |s|
      s.path= "helpers/installation.sh"
  end

  config.vm.provision "shell", run: "always", inline: <<-SHELL
    echo "Updating netplan with IP: #{simva_vm_ip}"
    sudo sed -i "s/^\\s*-\\s*[0-9\\.\\/]\\+$/      - #{simva_vm_ip}\\/24/" /etc/netplan/50-vagrant.yaml
    sudo netplan apply

    echo "Mounted parent folder is available at: #{mount_point}"
    # Example: list files from shared folder
    ls -l #{mount_point}
    # run simva script from the shared folder
    if [ -f #{mount_point}/docker-stacks/simva ]; then
      echo "Running simva from #{mount_point}..."
      dos2unix #{mount_point}/docker-stacks/simva
      #{mount_point}/docker-stacks/simva install
    fi
  SHELL
  
  # NAT (default) gives internet access
  # Private network gives host â†” VM access
  config.vm.network "private_network", ip: simva_vm_ip, adapter: 2

  # --- Read hostnames from external file ---
  hostnames_file = File.join(File.dirname(__FILE__), "hostnames.txt")
  hostnames = []
  if File.exist?(hostnames_file)
    hostnames = File.readlines(hostnames_file).map(&:strip).reject(&:empty?)
  else
    puts "Warning: hostnames.txt not found. No host entries will be added."
  end

  # Set first hostname as main VM hostname
  main_hostname = hostnames.shift || "traefik.external.test"
  config.vm.hostname = main_hostname

  # Hostmanager plugin configuration
  config.hostmanager.enabled = true
  config.hostmanager.manage_host = true   # modifies /etc/hosts on the HOST machine
  config.hostmanager.manage_guest = true  # modifies /etc/hosts inside the VM
  config.hostmanager.ignore_private_ip = false
  config.hostmanager.include_offline = true
  config.hostmanager.ip_resolver = proc do |vm, resolving_vm|
    simva_vm_ip  # VM static IP
  end

  # --- Add remaining hostnames as aliases ---
  config.hostmanager.aliases = hostnames unless hostnames.empty?

  # Forward Port for Docker
  config.vm.network "forwarded_port", guest: 80, host: 8888, host_ip: "127.0.0.1"
  config.vm.network "forwarded_port", guest: 443, host: 8443, host_ip: "127.0.0.1"
  #config.vm.network "forwarded_port", guest: 9229, host: 9229, host_ip: "127.0.0.1"
  #config.vm.network "forwarded_port", guest: 9230, host: 9230, host_ip: "127.0.0.1"
  #config.vm.network "forwarded_port", guest: 9231, host: 9231, host_ip: "127.0.0.1"
end